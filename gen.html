<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Weather Link</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .generator-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        #map {
            height: 400px;
            width: 100%;
            margin: 1rem 0;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .location-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .copy-link {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }

        .copy-link:hover {
            background: #45a049;
        }

        .back-link {
            color: #ffffff;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* Leaflet dark theme overrides */
        .leaflet-container {
            background: #2d2d2d !important;
        }

        .leaflet-control-zoom a {
            background-color: #1a1a1a !important;
            color: #ffffff !important;
            border-color: #333 !important;
        }

        .leaflet-control-zoom a:hover {
            background-color: #333 !important;
        }
    </style>
</head>
<body>
    <div class="generator-container">
        <a href="index.html" class="back-link">← Back to Weather</a>
        <h1>Generate Weather Link</h1>
        <p>Click on the map to select a location and generate a weather link.</p>
        
        <div id="map"></div>
        
        <div class="location-info">
            <h3>Selected Location</h3>
            <select id="city-select">
                <option value="">-- Select a city/station --</option>
            </select>
            <div id="city-weather-summary" style="display:none;"></div>
            <p id="selected-location">No location selected</p>
            <p id="coordinates"></p>
            <button class="copy-link" id="copy-link" disabled>Copy Weather Link</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let marker;
        let selectedLocation = null;
        let selectedCity = null;
        let stationsList = [];

        // Fetch SIAG stations and populate dropdown
        function fetchStations() {
            fetch('https://weather.services.siag.it/api/v2/station/')
                .then(res => res.json())
                .then(data => {
                    stationsList = data.rows;
                    const select = document.getElementById('city-select');
                    data.rows.forEach(station => {
                        const opt = document.createElement('option');
                        opt.value = station.name;
                        opt.textContent = station.name;
                        select.appendChild(opt);
                    });
                });
        }

        // Handle city selection
        document.addEventListener('DOMContentLoaded', () => {
            fetchStations();
            initMap();
            document.getElementById('city-select').addEventListener('change', (e) => {
                const cityName = e.target.value;
                selectedCity = stationsList.find(s => s.name === cityName);
                const summaryBox = document.getElementById('city-weather-summary');
                if (selectedCity) {
                    // Format last updated time
                    let lastUpdated = selectedCity.lastUpdated;
                    let formattedTime = '';
                    if (lastUpdated) {
                        const d = new Date(lastUpdated.replace('T', ' '));
                        formattedTime = `Last updated: ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}, ${d.toLocaleDateString()}`;
                    }
                    summaryBox.innerHTML = `
                        <div style="font-size:1.5rem;font-weight:700;">${selectedCity.name}</div>
                        <div style="font-size:2.2rem;margin:0.5rem 0;">${selectedCity.t ? selectedCity.t + '°C' : '--'}</div>
                        <div>Humidity: <b>${selectedCity.rh ? selectedCity.rh + '%' : '--'}</b></div>
                        <div>Wind: <b>${selectedCity.ff ? selectedCity.ff + ' km/h' : '--'} ${selectedCity.dd || ''}</b></div>
                        <div style="margin-top:0.5rem;font-size:1rem;color:#ccc;">${formattedTime}</div>
                    `;
                    summaryBox.style.display = '';
                    document.getElementById('selected-location').style.display = 'none';
                    document.getElementById('coordinates').style.display = 'none';
                    document.getElementById('copy-link').disabled = false;
                } else {
                    summaryBox.style.display = 'none';
                    document.getElementById('selected-location').style.display = '';
                    document.getElementById('coordinates').style.display = '';
                    document.getElementById('selected-location').textContent = 'No location selected';
                    document.getElementById('coordinates').textContent = '';
                    document.getElementById('copy-link').disabled = true;
                }
            });
        });

        // Initialize map
        function initMap() {
            map = L.map('map').setView([46.4983, 11.3548], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            map.on('click', (event) => {
                const lat = event.latlng.lat;
                const lng = event.latlng.lng;
                if (marker) {
                    marker.setLatLng(event.latlng);
                } else {
                    marker = L.marker(event.latlng).addTo(map);
                }
                // Try to fetch nearest station
                fetch(`https://weather.services.siag.it/api/v2/station?longitude=${lng}&latitude=${lat}&numStations=1&visibility=1`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.rows && data.rows.length > 0) {
                            selectedCity = data.rows[0];
                            selectedLocation = null;
                            document.getElementById('city-select').value = '';
                            // Format last updated time
                            let lastUpdated = selectedCity.lastUpdated;
                            let formattedTime = '';
                            if (lastUpdated) {
                                const d = new Date(lastUpdated.replace('T', ' '));
                                formattedTime = `Last updated: ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}, ${d.toLocaleDateString()}`;
                            }
                            const summaryBox = document.getElementById('city-weather-summary');
                            summaryBox.innerHTML = `
                                <div style="font-size:1.5rem;font-weight:700;">${selectedCity.name}</div>
                                <div style="font-size:2.2rem;margin:0.5rem 0;">${selectedCity.t ? selectedCity.t + '°C' : '--'}</div>
                                <div>Humidity: <b>${selectedCity.rh ? selectedCity.rh + '%' : '--'}</b></div>
                                <div>Wind: <b>${selectedCity.ff ? selectedCity.ff + ' km/h' : '--'} ${selectedCity.dd || ''}</b></div>
                                <div style="margin-top:0.5rem;font-size:1rem;color:#ccc;">${formattedTime}</div>
                            `;
                            summaryBox.style.display = '';
                            document.getElementById('selected-location').style.display = 'none';
                            document.getElementById('coordinates').style.display = 'none';
                            document.getElementById('copy-link').disabled = false;
                        } else {
                            // fallback to reverse geocode if no station found
                            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`)
                                .then(response => response.json())
                                .then(data => {
                                    selectedLocation = {
                                        name: data.display_name,
                                        lat: lat,
                                        lng: lng
                                    };
                                    selectedCity = null;
                                    document.getElementById('city-select').value = '';
                                    document.getElementById('city-weather-summary').style.display = 'none';
                                    document.getElementById('selected-location').style.display = '';
                                    document.getElementById('coordinates').style.display = '';
                                    document.getElementById('selected-location').textContent = selectedLocation.name;
                                    document.getElementById('coordinates').textContent = 
                                        `Latitude: ${lat.toFixed(4)}, Longitude: ${lng.toFixed(4)}`;
                                    document.getElementById('copy-link').disabled = false;
                                })
                                .catch(error => {
                                    console.error('Error getting location name:', error);
                                    selectedLocation = {
                                        name: `${lat.toFixed(4)}, ${lng.toFixed(4)}`,
                                        lat: lat,
                                        lng: lng
                                    };
                                    selectedCity = null;
                                    document.getElementById('city-select').value = '';
                                    document.getElementById('city-weather-summary').style.display = 'none';
                                    document.getElementById('selected-location').style.display = '';
                                    document.getElementById('coordinates').style.display = '';
                                    document.getElementById('selected-location').textContent = selectedLocation.name;
                                    document.getElementById('coordinates').textContent = 
                                        `Latitude: ${lat.toFixed(4)}, Longitude: ${lng.toFixed(4)}`;
                                    document.getElementById('copy-link').disabled = false;
                                });
                        }
                    });
            });
        }

        // Copy link to clipboard
        document.getElementById('copy-link').addEventListener('click', () => {
            const baseUrl = window.location.href.split('/gen.html')[0].replace(/\/$/, '');
            let weatherLink = '';
            if (selectedCity) {
                weatherLink = `${baseUrl}?city=${encodeURIComponent(selectedCity.name)}`;
            } else if (selectedLocation) {
                weatherLink = `${baseUrl}?lat=${selectedLocation.lat}&lng=${selectedLocation.lng}`;
            } else {
                return;
            }
            navigator.clipboard.writeText(weatherLink).then(() => {
                const button = document.getElementById('copy-link');
                button.textContent = 'Link Copied!';
                setTimeout(() => {
                    button.textContent = 'Copy Weather Link';
                }, 2000);
            });
        });
    </script>
</body>
</html> 